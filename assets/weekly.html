<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>每周日程</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      html, body { height: 100%; }
      input[type="time"] { caret-color: transparent; }
    </style>
    <!-- React + ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel Standalone to transpile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="min-h-screen bg-slate-100">
    <div id="root"></div>

    <script type="text/babel" data-presets="env,react">
      const { useState, useRef, useEffect } = React;

      function WeeklyEvents() {
        const weekDays = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'];
        const [selectedDay, setSelectedDay] = useState(6);

        // 清空初始事件
        const [events, setEvents] = useState({
          0: [], 1: [], 2: [], 3: [], 4: [], 5: [], 6: []
        });
        // 暴露给外部脚本：0..6 的事件数组
        useEffect(() => {
          // 返回一个新的对象，避免外部修改内部状态
          window.getWeeklyData = () => ({
            0: [...(events[0] || [])],
            1: [...(events[1] || [])],
            2: [...(events[2] || [])],
            3: [...(events[3] || [])],
            4: [...(events[4] || [])],
            5: [...(events[5] || [])],
            6: [...(events[6] || [])],
          });
          return () => { try { delete window.getWeeklyData; } catch(_) {} };
        }, [events]);


        const [editingId, setEditingId] = useState(null);
        const [showAddForm, setShowAddForm] = useState(false);
        const [newEvent, setNewEvent] = useState({
          startTime: '',
          endTime: '',
          title: '',
          color: 'bg-blue-400'
        });

        const colors = [
          { name: '蓝色', value: 'bg-blue-400' },
          { name: '绿色', value: 'bg-green-400' },
          { name: '橙色', value: 'bg-orange-400' },
          { name: '紫色', value: 'bg-purple-400' },
          { name: '粉色', value: 'bg-pink-400' },
          { name: '青色', value: 'bg-cyan-400' },
          { name: '深绿', value: 'bg-green-500' },
          { name: '深蓝', value: 'bg-blue-500' },
          { name: '靛蓝', value: 'bg-indigo-400' }
        ];

        // ====== 工具函数（30 分钟网格 & 禁止跨天） ======
        const timeToMinutes = (time) => {
          if (!time || !time.includes(':')) return NaN;
          const [hours, minutes] = time.split(':').map(Number);
          return hours * 60 + minutes;
        };

        const minutesToTime = (mins) => {
          const m = Math.max(0, Math.min(mins, 24 * 60)); // 0..1440
          const h = Math.floor(m / 60);
          const mm = m % 60;
          return String(h).padStart(2, '0') + ':' + String(mm).padStart(2, '0');
        };

        const snapToHalfHour = (mins) => Math.round(mins / 30) * 30;

        const endMinFromStart = (startStr) => {
          const sm = timeToMinutes(startStr);
          if (isNaN(sm)) return '00:30';
          let m = snapToHalfHour(sm) + 30;
          if (m >= 24 * 60) m = 24 * 60 - 1; // 23:59
          return minutesToTime(m);
        };

        const ensureHalfHourGrid = (startStr, endStr) => {
          const rawStart = timeToMinutes(startStr);
          const rawEnd = timeToMinutes(endStr);
          if (isNaN(rawStart) || isNaN(rawEnd)) return { ok: false, reason: 'empty' };
          if (rawEnd < rawStart) return { ok: false, reason: 'end_before_start' }; // 不支持跨天

          let start = snapToHalfHour(rawStart);
          let end = snapToHalfHour(rawEnd);

          if (end <= start) end = start + 30;
          if (end > 24 * 60) end = 24 * 60;
          if (start < 0) start = 0;
          if (end - start < 30) end = Math.min(start + 30, 24 * 60);

          const showTime = (m) => (m >= 24 * 60 ? '23:59' : minutesToTime(m));

          return {
            ok: true,
            startMin: start,
            endMin: end,
            start: minutesToTime(start),
            end: showTime(end)
          };
        };

        const hasOverlap = (dayItems, startMin, endMin, excludeId = null) =>
          (dayItems || []).some(it => {
            if (excludeId && it.id === excludeId) return false;
            const c = timeToMinutes(it.startTime);
            const d = timeToMinutes(it.endTime);
            return startMin < d && endMin > c;
          });

        const calculatePosition = (startTime, endTime) => {
          const startMinutes = timeToMinutes(startTime);
          const endMinutes = timeToMinutes(endTime);
          const top = (startMinutes / (24 * 60)) * 100;
          const height = ((endMinutes - startMinutes) / (24 * 60)) * 100;
          return { top: `${top}%`, height: `${height}%` };
        };

        // ====== 事件增删改 ======
        const handleAddEvent = () => {
          if (!newEvent.startTime || !newEvent.endTime || !newEvent.title) return;
          const checked = ensureHalfHourGrid(newEvent.startTime, newEvent.endTime);
          if (!checked.ok) {
            if (checked.reason === 'end_before_start') alert('结束时间必须晚于开始时间（不支持跨天）。');
            return;
          }
          const dayEvents = events[selectedDay] || [];
          if (hasOverlap(dayEvents, checked.startMin, checked.endMin)) {
            alert('该时间段与现有事件重叠，请调整后再添加。');
            return;
          }
          const toStore = { ...newEvent, id: Date.now(), startTime: checked.start, endTime: checked.end };
          setEvents({ ...events, [selectedDay]: [...dayEvents, toStore] });
          setNewEvent({ startTime: '', endTime: '', title: '', color: 'bg-blue-400' });
          if (newEvent.startTime !== checked.start || newEvent.endTime !== checked.end) {
            setTimeout(() => alert('时间已自动对齐到 30 分钟刻度，并保证至少 30 分钟时长'), 0);
          }
          setShowAddForm(false);
        };

        const handleDeleteEvent = (id) => {
          const dayEvents = events[selectedDay] || [];
          setEvents({ ...events, [selectedDay]: dayEvents.filter(item => item.id !== id) });
        };

        const handleEditField = (id, field, value) => {
          setEvents({
            ...events,
            [selectedDay]: (events[selectedDay] || []).map(item => (item.id === id ? { ...item, [field]: value } : item))
          });
        };

        const handleToggleEdit = (item) => {
          const isEditing = editingId === item.id;
          if (isEditing) {
            const checked = ensureHalfHourGrid(item.startTime, item.endTime);
            if (!checked.ok) {
              if (checked.reason === 'end_before_start') alert('结束时间必须晚于开始时间（不支持跨天）。');
              return; // 保持编辑态
            }
            const dayEvents = events[selectedDay] || [];
            if (hasOverlap(dayEvents, checked.startMin, checked.endMin, item.id)) {
              alert('该时间段与现有事件重叠，请调整后再保存。');
              return; // 保持编辑态
            }
            setEvents(prev => ({
              ...prev,
              [selectedDay]: (prev[selectedDay] || []).map(x =>
                x.id === item.id ? { ...x, startTime: checked.start, endTime: checked.end } : x
              )
            }));
            if (item.startTime !== checked.start || item.endTime !== checked.end) {
              setTimeout(() => alert('时间已自动对齐到 30 分钟刻度，并保证至少 30 分钟时长'), 0);
            }
            setEditingId(null);
          } else {
            setEditingId(item.id);
          }
        };

        const hours = Array.from({ length: 24 }, (_, i) => i);
        const currentDayEvents = events[selectedDay] || [];
        const timelineHeight = 720;

        const timeOptions = Array.from({ length: 48 }, (_, i) => {
          const h = Math.floor(i / 2);
          const m = i % 2 === 0 ? '00' : '30';
          return String(h).padStart(2, '0') + ':' + m;
        });

        // 阻止手动输入（允许 Tab 导航）
        const blockManualInput = (e) => {
          if (e.key === 'Tab') return;
          e.preventDefault();
        };

        // 打开原生时间选择器（修复 readonly 导致的无法弹出）
        const openNativePicker = (el) => {
          if (!el) return;
          const prev = el.readOnly;
          el.readOnly = false;
          try { if (el.showPicker) el.showPicker(); } catch {}
          setTimeout(() => { el.readOnly = prev; }, 0);
        };

        // Refs for add form inputs
        const addStartRef = useRef(null);
        const addEndRef = useRef(null);

        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-100 to-blue-50 p-4">
            <div className="max-w-6xl mx-auto">
              {/* Header */}
              <div className="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <div className="flex items-center justify-between">
                  <h1 className="text-2xl font-bold text-gray-800">每周日程</h1>
                  <button
                    onClick={() => setShowAddForm(!showAddForm)}
                    className="flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl transition-all shadow-md hover:shadow-lg"
                  >
                    <span className="font-semibold text-lg leading-none">＋</span>
                    添加事件
                  </button>
                </div>

                {/* Week Days Selector */}
                <div className="grid grid-cols-7 gap-2 mt-6">
                  {weekDays.map((day, index) => {
                    const hasEvents = events[index] && events[index].length > 0;
                    return (
                      <button
                        key={index}
                        onClick={() => setSelectedDay(index)}
                        className={
                          "p-4 rounded-xl transition-all " +
                          (selectedDay === index
                            ? "bg-blue-500 text-white shadow-lg scale-105"
                            : hasEvents
                            ? "bg-blue-50 text-blue-600 hover:bg-blue-100"
                            : "bg-gray-50 text-gray-600 hover:bg-gray-100")
                        }
                      >
                        <div className="text-sm font-medium">{day}</div>
                      </button>
                    );
                  })}
                </div>
              </div>

              {/* Add Form */}
              {showAddForm && (
                <div className="bg-white rounded-2xl shadow-lg p-6 mb-6">
                  <h2 className="text-xl font-bold text-gray-800 mb-4">
                    添加新事件到 {weekDays[selectedDay]}
                  </h2>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">开始时间</label>
                      <input
                        ref={addStartRef}
                        type="time"
                        step="1800" min="00:00" max="23:59" list="halfHourMarks"
                        value={newEvent.startTime}
                        readOnly
                        onKeyDown={blockManualInput}
                        onKeyPress={blockManualInput}
                        onPaste={blockManualInput}
                        onCut={blockManualInput}
                        onDrop={blockManualInput}
                        onClick={() => openNativePicker(addStartRef.current)}
                        onFocus={() => openNativePicker(addStartRef.current)}
                        onChange={(e) => setNewEvent({ ...newEvent, startTime: e.target.value })}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">结束时间</label>
                      <input
                        ref={addEndRef}
                        type="time"
                        step="1800"
                        min={endMinFromStart(newEvent.startTime)}
                        max="23:59"
                        list="halfHourMarks"
                        value={newEvent.endTime}
                        readOnly
                        onKeyDown={blockManualInput}
                        onKeyPress={blockManualInput}
                        onPaste={blockManualInput}
                        onCut={blockManualInput}
                        onDrop={blockManualInput}
                        onClick={() => openNativePicker(addEndRef.current)}
                        onFocus={() => openNativePicker(addEndRef.current)}
                        onChange={(e) => setNewEvent({ ...newEvent, endTime: e.target.value })}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      />
                      <p className="text-xs text-gray-500 mt-1">结束时间需晚于开始时间，且为半小时刻度。</p>
                    </div>
                  </div>
                  <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-700 mb-2">事件名称</label>
                    <input
                      type="text"
                      value={newEvent.title}
                      onChange={(e) => setNewEvent({ ...newEvent, title: e.target.value })}
                      placeholder="例如：在校园里闲逛"
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                  </div>
                  <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-700 mb-2">选择颜色</label>
                    <div className="flex flex-wrap gap-2">
                      {colors.map((color) => (
                        <button
                          type="button"
                          key={color.value}
                          onClick={() => setNewEvent({ ...newEvent, color: color.value })}
                          className={
                            "w-12 h-12 rounded-lg " + color.value + 
                            (newEvent.color === color.value ? " ring-4 ring-gray-400" : "") +
                            " transition-all hover:scale-110"
                          }
                          title={color.name}
                        />
                      ))}
                    </div>
                  </div>
                  <div className="flex gap-3">
                    <button
                      onClick={handleAddEvent}
                      className="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg transition-all"
                    >
                      添加
                    </button>
                    <button
                      onClick={() => setShowAddForm(false)}
                      className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 rounded-lg transition-all"
                    >
                      取消
                    </button>
                  </div>

                  <datalist id="halfHourMarks">
                    {timeOptions.map((t) => <option key={t} value={t} />)}
                  </datalist>
                </div>
              )}

              {/* Events Timeline */}
              <div className="bg-white rounded-2xl shadow-lg p-6">
                <h2 className="text-lg font-bold text-gray-800 mb-4">
                  {weekDays[selectedDay]}
                </h2>
                <div className="flex">
                  {/* Time Labels */}
                  <div className="w-16 flex-shrink-0 relative" style={{ height: timelineHeight + 'px' }}>
                    {hours.map((hour) => (
                      <div
                        key={hour}
                        className="absolute text-xs text-gray-500 -translate-y-2 font-medium"
                        style={{ top: `${(hour / 24) * 100}%` }}
                      >
                        {hour.toString().padStart(2, '0')}
                      </div>
                    ))}
                  </div>

                  {/* Timeline */}
                  <div className="flex-1 relative border-l-2 border-gray-200" style={{ height: timelineHeight + 'px' }}>
                    {hours.map((hour) => (
                      <div
                        key={hour}
                        className="absolute w-full border-t border-gray-100"
                        style={{ top: `${(hour / 24) * 100}%` }}
                      />
                    ))}

                    {/* Event Blocks */}
                    {currentDayEvents.map((item) => {
                      const position = calculatePosition(item.startTime, item.endTime);
                      const isEditing = editingId === item.id;

                      return (
                        <div
                          key={item.id}
                          className={`absolute ${item.color} rounded-xl shadow-md overflow-hidden transition-all hover:shadow-lg`}
                          style={{
                            top: position.top,
                            height: `calc(${position.height} - 8px)`,
                            left: '12px',
                            right: '12px'
                          }}
                        >
                          <div className="h-full p-3 flex flex-col justify-between">
                            <div className="flex justify-between items-start">
                              {isEditing ? (
                                <input
                                  type="text"
                                  value={item.title}
                                  onChange={(e) => handleEditField(item.id, 'title', e.target.value)}
                                  className="flex-1 bg-white bg-opacity-90 rounded px-2 py-1 text-sm font-medium text-gray-800"
                                  autoFocus
                                />
                              ) : (
                                <div className="flex-1">
                                  <div className="text-white font-semibold text-sm mb-1">
                                    {item.title}
                                  </div>
                                  <div className="text-white/90 text-xs">
                                    {item.startTime} - {item.endTime}
                                  </div>
                                </div>
                              )}
                              <div className="flex gap-1 ml-2">
                                <button
                                  onClick={() => handleToggleEdit(item)}
                                  className="bg-white/20 hover:bg-white/30 text-white px-2 py-1 rounded transition-all text-xs font-medium"
                                  title={isEditing ? "保存" : "编辑"}
                                >
                                  {isEditing ? '保存' : '编辑'}
                                </button>
                                <button
                                  onClick={() => handleDeleteEvent(item.id)}
                                  className="bg-white/20 hover:bg-white/30 text-white px-2 py-1 rounded transition-all text-xs font-medium"
                                  title="删除"
                                >
                                  ×
                                </button>
                              </div>
                            </div>
                            {isEditing && (
                              <div className="flex gap-2 mt-2">
                                <input
                                  type="time" step="1800" min="00:00" max="23:59" list="halfHourMarks"
                                  value={item.startTime}
                                  readOnly
                                  onKeyDown={blockManualInput}
                                  onKeyPress={blockManualInput}
                                  onPaste={blockManualInput}
                                  onCut={blockManualInput}
                                  onDrop={blockManualInput}
                                  onClick={(e) => openNativePicker(e.currentTarget)}
                                  onFocus={(e) => openNativePicker(e.currentTarget)}
                                  onChange={(e) => handleEditField(item.id, 'startTime', e.target.value)}
                                  className="flex-1 bg-white bg-opacity-90 rounded px-2 py-1 text-xs"
                                />
                                <input
                                  type="time" step="1800"
                                  min={endMinFromStart(item.startTime)}
                                  max="23:59" list="halfHourMarks"
                                  value={item.endTime}
                                  readOnly
                                  onKeyDown={blockManualInput}
                                  onKeyPress={blockManualInput}
                                  onPaste={blockManualInput}
                                  onCut={blockManualInput}
                                  onDrop={blockManualInput}
                                  onClick={(e) => openNativePicker(e.currentTarget)}
                                  onFocus={(e) => openNativePicker(e.currentTarget)}
                                  onChange={(e) => handleEditField(item.id, 'endTime', e.target.value)}
                                  className="flex-1 bg-white bg-opacity-90 rounded px-2 py-1 text-xs"
                                />
                              </div>
                            )}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<WeeklyEvents />);
    </script>
  
<!-- Routine Manager banner -->
<script>
(function(){
  const bar = document.createElement('div');
  bar.style.position='fixed'; bar.style.right='12px'; bar.style.bottom='12px';
  bar.style.background='#111827'; bar.style.color='#fff'; bar.style.padding='10px 12px';
  bar.style.borderRadius='12px'; bar.style.boxShadow='0 8px 24px rgba(0,0,0,.2)';
  bar.style.zIndex='9999'; bar.style.fontSize='12px';
  bar.innerHTML = '按 Ctrl+Shift+S 保存到 AstrBot（需我这边额外接入 state，稍后我会提交）';
  document.body.appendChild(bar);
  setTimeout(()=>bar.remove(), 6000);
})();
</script>

<script>
(function(){
  function buildWeeklyFromData(data){
    var WEEK_KEYS=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    var weekly = {Mon:{}, Tue:{}, Wed:{}, Thu:{}, Fri:{}, Sat:{}, Sun:{}};
    WEEK_KEYS.forEach(function(k, di){
      var arr = (data[di]||[]);
      arr.forEach(function(item){
        if(!item || !item.startTime || !item.endTime) return;
        var title = (item.title||'').trim();
        weekly[k][item.startTime + '-' + item.endTime] = title;
      });
    });
    return weekly;
  }
  async function saveToAstrBot(){
    if(!window.confirm('确认保存到 AstrBot 并立即生效？')) return;
    if(typeof window.getWeeklyData !== 'function'){
      alert('请在 Weekly 组件中实现 window.getWeeklyData()，返回 {0:[...],...,6:[...]}');
      return;
    }
    var data = window.getWeeklyData();
    var weekly = buildWeeklyFromData(data);
    var payload = {
      timezone: 'Asia/Shanghai',
      inject_scope: 'all',
      schedule: weekly,
      prompt: { routine_prompt_template: '现在时间：{now} 当前行为：{action} 请在语气和内容上贴合该场景进行回复。' }
    };
    try{
      var r = await fetch('/api/config', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      var j = await r.json();
      if(j.ok){ toast('✅ 已保存'); } else { toast('❌ 保存失败：'+(j.error||'')); }
    }catch(e){ toast('❌ 保存异常：'+e.message); }
  }
  function toast(text){
    var t=document.createElement('div');
    t.textContent=text;
    t.style.position='fixed'; t.style.right='16px'; t.style.bottom='76px';
    t.style.background='#111827'; t.style.color='#fff'; t.style.padding='10px 12px';
    t.style.borderRadius='12px'; t.style.boxShadow='0 8px 24px rgba(0,0,0,.2)'; t.style.zIndex=9999;
    document.body.appendChild(t); setTimeout(function(){ t.remove(); }, 1800);
  }
  var btn=document.createElement('button');
  btn.textContent='保存';
  btn.style.position='fixed'; btn.style.right='16px'; btn.style.bottom='16px';
  btn.style.background='#111827'; btn.style.color='#fff'; btn.style.border='0';
  btn.style.padding='10px 14px'; btn.style.borderRadius='12px'; btn.style.cursor='pointer';
  btn.style.boxShadow='0 8px 24px rgba(0,0,0,.2)'; btn.style.zIndex=9999;
  btn.onclick=saveToAstrBot;
  document.addEventListener('DOMContentLoaded', function(){ document.body.appendChild(btn); });
})();
</script>
</body>
</html>

